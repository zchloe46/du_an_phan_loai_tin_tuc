{% extends 'base.html' %}

{% block title %}Báo cáo & Thống kê{% endblock %}

{% block content %}
<!-- Load ApexCharts từ CDN -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<div class="space-y-6">
    
    <!-- 1. HEADER -->
    <div class="flex flex-col md:flex-row md:items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-slate-800">Tổng quan hệ thống</h1>
            <p class="text-slate-500 text-sm mt-1">Dữ liệu được cập nhật theo thời gian thực.</p>
        </div>
        <div class="mt-4 md:mt-0">
            <button onclick="window.print()" class="flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 shadow-sm">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"></path></svg>
                Xuất báo cáo PDF
            </button>
        </div>
    </div>

    <!-- 2. SUMMARY CARDS (KPIs) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Card 1: Tổng bài viết -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center">
            <div class="p-4 bg-indigo-50 rounded-full text-indigo-600 mr-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-500">Tổng bài viết</p>
                <h3 class="text-2xl font-bold text-slate-800">{{ total_articles }}</h3>
                <p class="text-xs text-green-600 flex items-center mt-1">
                    <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                    Dữ liệu tích lũy
                </p>
            </div>
        </div>

        <!-- Card 2: Bài viết hôm nay -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center">
            <div class="p-4 bg-green-50 rounded-full text-green-600 mr-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-500">Hôm nay</p>
                <h3 class="text-2xl font-bold text-slate-800">+{{ articles_today }}</h3>
                <p class="text-xs text-slate-400 mt-1">Cập nhật liên tục</p>
            </div>
        </div>

        <!-- Card 3: Chất lượng AI -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 flex items-center">
            <div class="p-4 bg-pink-50 rounded-full text-pink-600 mr-4">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            </div>
            <div>
                <p class="text-sm font-medium text-slate-500">Độ tin cậy AI TB</p>
                <h3 class="text-2xl font-bold text-slate-800">{{ avg_confidence }}%</h3>
                <div class="w-24 h-1.5 bg-gray-200 rounded-full mt-2">
                    <div class="h-full bg-pink-500 rounded-full" style="width: {{ avg_confidence }}%"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. MAIN CHARTS ROW -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Biểu đồ 1: Xu hướng tin tức (Chiếm 2 phần) -->
        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Xu hướng thu thập tin tức</h3>
            <div id="trendChart" class="w-full h-80"></div>
        </div>

        <!-- Biểu đồ 2: Phân bố chủ đề (Chiếm 1 phần) -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Tỷ lệ chủ đề</h3>
            <div id="categoryChart" class="w-full h-80 flex justify-center"></div>
        </div>
    </div>

    <!-- 4. SECONDARY CHARTS ROW -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Biểu đồ 3: Chất lượng AI -->
        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
            <h3 class="text-lg font-bold text-slate-800 mb-4">Đánh giá độ tin cậy AI</h3>
            <div id="confidenceChart" class="w-full h-64"></div>
        </div>

        <!-- Khu vực thông tin thêm (Ví dụ: Logs) -->
        <div class="bg-indigo-900 p-6 rounded-xl shadow-sm border border-indigo-800 text-white flex flex-col justify-between relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="text-xl font-bold mb-2">Hệ thống đang hoạt động tốt</h3>
                <p class="text-indigo-200 mb-6">Crawler tự động đang chạy nền với chu kỳ 15 phút. AI Model v2.0 đang hoạt động với độ chính xác cao.</p>
                <a href="{% url 'home' %}" class="inline-block bg-white text-indigo-900 px-6 py-2 rounded-lg font-bold hover:bg-indigo-50 transition">
                    Về trang quản lý
                </a>
            </div>
            <!-- Decor hình nền -->
            <div class="absolute -bottom-10 -right-10 w-40 h-40 bg-indigo-500 rounded-full opacity-20 blur-2xl"></div>
            <div class="absolute top-10 right-10 w-20 h-20 bg-pink-500 rounded-full opacity-20 blur-xl"></div>
        </div>
    </div>

</div>

<!-- SCRIPT VẼ BIỂU ĐỒ -->
{% comment %} <script>
    // 1. Cấu hình Biểu đồ Xu hướng (Area Chart)
    var trendOptions = {
        series: [{
            name: 'Số bài viết',
            data: {{ chart_counts|safe }} // Dữ liệu từ Django
        }],
        chart: {
            type: 'area',
            height: 320,
            toolbar: { show: false },
            fontFamily: 'Inter, sans-serif',
        },
        colors: ['#6366f1'], // Màu Indigo
        dataLabels: { enabled: false },
        stroke: { curve: 'smooth', width: 2 },
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.7,
                opacityTo: 0.2,
                stops: [0, 90, 100]
            }
        },
        xaxis: {
            categories: {{ chart_dates|safe }}, // Ngày tháng từ Django
            axisBorder: { show: false },
            axisTicks: { show: false }
        },
        grid: {
            borderColor: '#f1f5f9',
        }
    };
    var trendChart = new ApexCharts(document.querySelector("#trendChart"), trendOptions);
    trendChart.render();

    // 2. Cấu hình Biểu đồ Chủ đề (Donut Chart)
    var catOptions = {
        series: {{ cat_counts|safe }}, // Số lượng bài theo chủ đề
        labels: {{ cat_names|safe }}, // Tên chủ đề
        chart: {
            type: 'donut',
            height: 320,
            fontFamily: 'Inter, sans-serif',
        },
        colors: ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6'], // Blue, Green, Red, Yellow, Purple
        legend: {
            position: 'bottom'
        },
        plotOptions: {
            pie: {
                donut: {
                    size: '65%',
                    labels: {
                        show: true,
                        total: {
                            show: true,
                            label: 'Tổng cộng',
                            color: '#64748b'
                        }
                    }
                }
            }
        }
    };
    var catChart = new ApexCharts(document.querySelector("#categoryChart"), catOptions);
    catChart.render();

    // 3. Cấu hình Biểu đồ Độ tin cậy (Bar Chart)
    var confOptions = {
        series: [{
            name: 'Số lượng bài',
            data: {{ conf_data|safe }} // [Cao, Trung bình, Thấp]
        }],
        chart: {
            type: 'bar',
            height: 250,
            toolbar: { show: false },
            fontFamily: 'Inter, sans-serif',
            // SỰ KIỆN CLICK
            events: {
                    dataPointSelection: function(event, chartContext, config) {
                        // Lấy chỉ số cột được click (0: Cao, 1: Trung bình, 2: Thấp)
                        var index = config.dataPointIndex;
                        
                        // Map chỉ số sang tham số URL
                        var levels = ['high', 'medium', 'low'];
                        var selectedLevel = levels[index];
                        
                        // Chuyển hướng sang trang Home với tham số lọc
                        window.location.href = "{% url 'home' %}?confidence_level=" + selectedLevel;
                    }
                }
        },
        
        plotOptions: {
            bar: {
                borderRadius: 4,
                horizontal: true,
                distributed: true // Để mỗi cột 1 màu
                barHeight: '70%'
            }
        },
        colors: ['#10b981', '#f59e0b', '#ef4444'], // Xanh, Vàng, Đỏ
        dataLabels: { enabled: true },
        xaxis: {
            categories: ['Tin cậy cao (>80%)', 'Trung bình (50-80%)', 'Thấp (<50%)'],
        },
        legend: { show: false }
    };
    var confChart = new ApexCharts(document.querySelector("#confidenceChart"), confOptions);
    confChart.render();
</script> {% endcomment %}
<!-- SCRIPT VẼ BIỂU ĐỒ -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        
        // --- DEBUG: Kiểm tra xem dữ liệu có vào không ---
        console.log("Dates:", {{ chart_dates|safe }}); 
        console.log("Counts:", {{ chart_counts|safe }});

        // 1. BIỂU ĐỒ XU HƯỚNG
        var trendOptions = {
            series: [{
                name: 'Số bài viết',
                // QUAN TRỌNG: Phải có |safe
                data: {{ chart_counts|safe }} 
            }],
            chart: {
                type: 'area',
                height: 320,
                toolbar: { show: false },
                fontFamily: 'Inter, sans-serif',
            },
            colors: ['#6366f1'],
            stroke: { curve: 'smooth', width: 2 },
            fill: {
                type: 'gradient',
                gradient: { shadeIntensity: 1, opacityFrom: 0.7, opacityTo: 0.2, stops: [0, 90, 100] }
            },
            xaxis: {
                // QUAN TRỌNG: Phải có |safe
                categories: {{ chart_dates|safe }}, 
                axisBorder: { show: false },
                axisTicks: { show: false }
            },
            grid: { borderColor: '#f1f5f9' },
            dataLabels: { enabled: false }
        };
        
        // Kiểm tra nếu có dữ liệu thì mới vẽ
        if (document.querySelector("#trendChart")) {
            var trendChart = new ApexCharts(document.querySelector("#trendChart"), trendOptions);
            trendChart.render();
        }

        // 2. BIỂU ĐỒ CHỦ ĐỀ
        var catOptions = {
            // QUAN TRỌNG: Phải có |safe
            series: {{ cat_counts|safe }}, 
            labels: {{ cat_names|safe }}, 
            chart: {
                type: 'donut',
                height: 320,
                fontFamily: 'Inter, sans-serif',
            },
            colors: ['#3b82f6', '#10b981', '#ef4444', '#f59e0b', '#8b5cf6'],
            legend: { position: 'bottom' },
            plotOptions: {
                pie: {
                    donut: {
                        size: '65%',
                        labels: { show: true, total: { show: true, label: 'Tổng cộng', color: '#64748b' } }
                    }
                }
            }
        };
        if (document.querySelector("#categoryChart")) {
            var catChart = new ApexCharts(document.querySelector("#categoryChart"), catOptions);
            catChart.render();
        }

        // 3. BIỂU ĐỒ ĐỘ TIN CẬY
        var confOptions = {
            series: [{
                name: 'Số lượng bài',
                // QUAN TRỌNG: Phải có |safe
                data: {{ conf_data|safe }} 
            }],
            chart: {
                type: 'bar',
                height: 250,
                toolbar: { show: false },
                fontFamily: 'Inter, sans-serif',
                events: {
                    dataPointSelection: function(event, chartContext, config) {
                        var index = config.dataPointIndex;
                        var levels = ['high', 'medium', 'low'];
                        var selectedLevel = levels[index];
                        window.location.href = "{% url 'home' %}?confidence_level=" + selectedLevel;
                    }
                }
            },
            plotOptions: {
                bar: { borderRadius: 4, horizontal: true, distributed: true, barHeight: '70%' }
            },
            colors: ['#10b981', '#f59e0b', '#ef4444'],
            dataLabels: { enabled: true },
            xaxis: {
                categories: ['Tin cậy cao (>80%)', 'Trung bình (50-80%)', 'Thấp (<50%)'],
            },
            legend: { show: false }
        };
        if (document.querySelector("#confidenceChart")) {
            var confChart = new ApexCharts(document.querySelector("#confidenceChart"), confOptions);
            confChart.render();
        }
    });
</script>
{% endblock %}